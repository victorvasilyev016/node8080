load_module /usr/lib/nginx/modules/ngx_stream_module.so;

worker_processes 1;
error_log /var/log/nginx/error.log notice;

events { worker_connections 1024; }

stream {
    log_format stream_fmt
        '$remote_addr:$remote_port -> $server_addr:$server_port '
        'alpn=$ssl_preread_alpn_protocols sni=$ssl_preread_server_name '
        'bytes_in=$bytes_received bytes_out=$bytes_sent '
        'time=$session_time status=$status';
    access_log /var/log/nginx/stream_access.log stream_fmt;

    # --- внутренние назначения ---
    upstream marznode_grpc {
        server 127.0.0.1:5566;   # MarzNode gRPC
    }

    upstream xray_backend {
        server 127.0.0.1:2099;   # Xray / VLESS / HTTPUpgrade
    }

    # --- выбор назначения по SNI ---
    # если домен оканчивается на .10-103.ru → панель
    # всё остальное → Xray
    map $ssl_preread_server_name $backend {
        "~\.10-103\.ru$" marznode_grpc;
        default          xray_backend;
    }

    server {
        listen 8080 reuseport;
        ssl_preread on;
        proxy_connect_timeout 5s;
        proxy_timeout 300s;
        proxy_pass $backend;
    }
}
